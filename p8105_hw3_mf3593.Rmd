---
title: "p8105_hw3_mf3593"
author: "Miao Fu"
date: "2023-10-11"
output: html_document
---
```{r,include=FALSE}
library(dplyr)
library(ggridges)
library(tidyverse)
library(knitr)
library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	error=FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "100%"
)

```

# Problem 1

```{r}
data("instacart") 
df_insta=data.frame(instacart)|>
  group_by(aisle)|>
  summarize(n_obs=n())|>
  arrange(desc(n_obs))

df_insta|>
  filter(n_obs>10000)|>
  ggplot(aes(x=aisle,y=n_obs))+geom_point()+
  xlab("Aisle") +
  ylab("Number of ordered items") +
  theme(axis.text.x=element_text(angle=70,hjust=1))


data.frame(instacart) |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |>
  group_by(aisle) |> 
  count(product_name) |> 
  mutate(rank = min_rank(desc(n))) |> 
  filter(rank < 4) |> 
  arrange(desc(n)) |>
  knitr::kable()

data.frame(instacart)|>
  filter(product_name %in% c("Pink Lady Apples","Coffee Ice Cream"))|>
  arrange(product_name,order_dow,order_hour_of_day)|>
  group_by(product_name,order_dow)|>
  summarize(
    mean_hour=mean(order_hour_of_day)
  )|>
  pivot_wider(
    id_cols=order_dow,
    names_from=product_name,
    values_from=mean_hour,
    names_prefix="Mean order hour of day of "
  )|>
  rename("Day of Week"="order_dow")|>
  knitr::kable(digits=3)

```

The dataset of instacart has `r nrow(instacart)` rows and `r ncol(instacart)` columns. It includes information on variables `r colnames(instacart)`. \
1. There are `r nrow(df_insta)` aisles and most items are ordered from aisle number `r df_insta[1,1]` \
2. The number of items ordered(>10000) for each aisle is pretty evenly distributed. Aisle fresh vegetables and fresh fruits have the greatest number of ordered item, following packaged vegetables and fruits being the third most. \
3. The item_table shows top three ordered items' product_id in each aisle as well as the number of ordered items. We see that number of items ordered in dog food care is much less compared to aisle baking ingredient and packaged fruits and vegetables. \
4. The hour_table shows mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week. Coffee ice cream appears to have a later order hour of the day compared to pink lady apples. The mean order hour of day for both products fall between 11 to 15. 

# Problem 2 

```{r}
data("brfss_smart2010")
df_brfss=data.frame(brfss_smart2010)|>
  janitor::clean_names()|>
  filter(topic=="Overall Health" & response %in% c("Excellent","Very good","Good","Fair","Poor"))|>
  mutate(response_fac=factor(response,levels=c("Poor","Fair","Good","Very good","Excellent")))|>
  select(-response)

location2002=df_brfss|>
  filter(year==2002)|>
  group_by(locationabbr)|>
  summarize(n_obs=n_distinct(geo_location))|>
  filter(n_obs>=7)

location2010=df_brfss|>
  filter(year==2010)|>
  group_by(locationabbr)|>
  summarize(n_obs=n_distinct(geo_location))|>
  filter(n_obs>=7)
```
1. The following states were observed at 7 or more locations in 2002:`r pull(location2002,locationabbr)` The following states were observed at 7 or more locations in 2010:`r pull(location2010,locationabbr)`.
```{r}

df_brfss|>
  filter(response_fac=="Excellent")|>
  select(year,locationabbr,response_fac,data_value,geo_location)|>
  rename("state"="locationabbr")|>
  group_by(state,year)|>
  summarize(mean=mean(data_value,na.rm=TRUE))|>
  ggplot(aes(x=year,y=mean,group=state,color=state))+geom_line()+
  labs(
    title="Average Data Value Across Year Per State",
    x="Year",
    y="Average Data Value"
  )+
  theme_bw()
```
The mean for `data_value` distribution for each state from year 2002 to 2010 falls generally between 15 to 30. We see a relative decrease of mean `data_value` for the year of 2005 for most states. But overall the `data_value` fluctuates around 23. 
```{r}
df_brfss|>
  filter(locationabbr=="NY" & year %in%c(2006,2010))|>
  ggplot(aes(x=locationdesc,y=data_value,fill=response_fac))+
  geom_bar(stat="identity",position="dodge")+
  facet_grid(~year)+
  labs(
    title="Data Value distribution for responses in NY",
    x="Location",
    y="Data Value",
    fill="Response"
  )+
  theme(legend.position="bottom",
        axis.text.x=element_text(angle=90,hjust=1))
```

According to the graph `Data Value distribution for response in NY`, distribution of data value among responses are similar for year 2006 and 2010. 2010 has slightly more people who responded `very good` compared to year 2006. Overall, response `very good` and `good` have the highest data values and `poor` has the lowest data values in NY state for both 2006 and 2010. 

# Problem 3
```{r}
demo_df=read_csv("nhanes_covar.csv",skip=4)|>
  janitor::clean_names()|>
  filter(age>=21)|>
  mutate(
    sex=case_match(
      sex,
      2 ~ "female",
      1 ~ "male"
    ),
    sex=as.factor(sex),
    education=case_match(
      education,
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"
    ),
    education=as.factor(education)
  )

acc_df=read_csv("nhanes_accel.csv")|>
  janitor::clean_names()|>
   pivot_longer(
    min1:min1440,
    names_to="time",
    values_to="mims")

combined_df=demo_df|>
  left_join(acc_df)

combined_df|>
  group_by(education,sex)|>
  summarize(n_obs=n_distinct(seqn))|>
  pivot_wider(
    names_from="sex",
    values_from="n_obs",
    id_cols="education"
  )|>
  knitr::kable()
```
There are more male with high school equivalent background than female. There are roughly same number of males and females with education less than high school. There are slightly more female than male with education more than high school. Most females and males have education more than high school. 

```{r}
combined_df|>
  group_by(seqn)|>
  summarise(mims_total=sum(mims))|>
  right_join(demo_df)|>
  ggplot(aes(x=age,y=mims_total))+geom_point(aes(color=sex))+
  geom_smooth(aes(color=sex),se=FALSE)+
  facet_grid(~education)+
  labs(
    title="Total MIMS activity across age and education level",
    x="AGE",
    y="MIMS value"
  )
```
The plot shows the MIMS total activity across age and education level for females and males. The data is quite spread out. We see mean MIMS value are roughly same for people from all three education levels. Females tend to have slightly higher MIMS value compared to males. MIMS seems to decrease as increase of age for both men and women in all three education levels. 

```{r}
combined_df|>
  mutate(time=as.numeric(gsub("min","",time)))|>
  group_by(education,time,sex)|>
  summarise(mims_day=sum(mims))|>
  ggplot(aes(x=time,y=mims_day))+geom_point(aes(color=sex))+
  facet_grid(~education)+
  geom_smooth()+
  labs(
    x="Minute of 24 hours",
    y="MIMS value",
    title="24-hour activity for different education level"
  )+
  theme(axis.text.x=element_text(angle=90,hjust=1))
  
```
The graph shows the trend of 24-hour MIMS activity for different education levels among female and male subjects. MIMS value of subjects from more than high school background has a much higher MIMS value than subjects from high school equivalent and less than high school backgrounds.For all subjects across three education levels, the MIMS value decreases first from minute 1 to minute 250 and then increase till reaching a plateu at around minute 500, then decrease at around minute1250. Female and male share similar MIMS activity across 24 hours. 


